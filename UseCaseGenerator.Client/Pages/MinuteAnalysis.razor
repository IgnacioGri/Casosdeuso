@page "/minute-analysis"
@using MudBlazor
@using UseCaseGenerator.Shared.DTOs
@using UseCaseGenerator.Shared.Models
@using UseCaseGenerator.Client.Services
@using UseCaseGenerator.Client.Components
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components
@inject IAIAssistService AIAssistService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>Análisis de Minutas</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large">
    <MudPaper Elevation="2" Class="pa-6">
        <MudText Typo="Typo.h4" GutterBottom="true" Color="Color.Primary">
            Análisis Inteligente de Minutas
        </MudText>
        <MudText Typo="Typo.body1" Class="mb-4">
            Sube un documento de minuta y el sistema extraerá automáticamente la información del caso de uso usando IA.
        </MudText>
        
        <MudGrid>
            <!-- AI Model Selection -->
            <MudItem xs="12" md="4">
                <MudCard Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">Configuración IA</MudText>
                    <MudSelect @bind-Value="selectedAIModel" 
                               Label="Modelo de IA" 
                               Variant="Variant.Outlined"
                               Class="mb-3" T="AIModel">
                        <MudSelectItem Value="AIModel.Demo">Modo Demo</MudSelectItem>
                        <MudSelectItem Value="AIModel.OpenAI">OpenAI GPT-4o</MudSelectItem>
                        <MudSelectItem Value="AIModel.Claude">Claude Sonnet</MudSelectItem>
                        <MudSelectItem Value="AIModel.Gemini">Google Gemini</MudSelectItem>
                        <MudSelectItem Value="AIModel.Grok">Grok (X.AI)</MudSelectItem>
                        <MudSelectItem Value="AIModel.Copilot">Microsoft Copilot</MudSelectItem>
                    </MudSelect>
                </MudCard>
            </MudItem>
            
            <!-- File Upload -->
            <MudItem xs="12" md="8">
                <MudCard Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">Subir Minuta</MudText>
                    
                    <MudFileUpload T="IBrowserFile" 
                                   OnFilesChanged="OnInputFileChanged"
                                   Hidden="false" 
                                   Class="flex-1" 
                                   InputClass="absolute mud-width-full mud-height-full overflow-hidden z-20"
                                   InputStyle="opacity:0"
                                   @ondragenter="() => SetDragClass()" 
                                   @ondragleave="() => ClearDragClass()" 
                                   @ondragend="() => ClearDragClass()">
                        <ChildContent>
                            <MudPaper Height="200px" 
                                      Outlined="true" 
                                      Class="@dragClass">
                                <MudButton HtmlTag="label"
                                           Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.CloudUpload"
                                           for="fileInput">
                                    Seleccionar Archivo
                                </MudButton>
                                <MudText Typo="Typo.body2" Class="mt-2">
                                    O arrastra el archivo aquí
                                </MudText>
                                <MudText Typo="Typo.caption">
                                    Formatos soportados: .txt, .docx, .pptx, .ppt, .xlsx
                                </MudText>
                            </MudPaper>
                        </ChildContent>
                    </MudFileUpload>
                    
                    @if (uploadedFile != null)
                    {
                        <MudAlert Severity="Severity.Success" Class="mt-3">
                            Archivo seleccionado: @uploadedFile.Name
                        </MudAlert>
                    }
                </MudCard>
            </MudItem>
            
            <!-- Manual Input -->
            <MudItem xs="12">
                <MudCard Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">O Ingresa el Contenido Manualmente</MudText>
                    
                    <MudTextField @bind-Value="minuteContent"
                                  Label="Contenido de la minuta"
                                  Variant="Variant.Outlined"
                                  Lines="10"
                                  Placeholder="Pega aquí el contenido de la minuta a analizar..."
                                  Class="mb-3" T="string" />
                    
                    <MudButton Variant="Variant.Filled" 
                               Color="@(isAnalyzing ? Color.Secondary : Color.Primary)"
                               StartIcon="@(isAnalyzing ? null : Icons.Material.Filled.Analytics)"
                               OnClick="AnalyzeMinute"
                               Disabled="@(isAnalyzing || (string.IsNullOrWhiteSpace(minuteContent) && uploadedFile == null))"
                               Class="@(isAnalyzing ? "thinking-button" : "")">
                        @if (isAnalyzing)
                        {
                            <div class="thinking-button-content">
                                <div class="thinking-pulse"></div>
                                <span class="thinking-text">Pensando<span class="thinking-dots">@currentDots</span></span>
                            </div>
                        }
                        else
                        {
                            <span>Analizar Minuta</span>
                        }
                    </MudButton>
                </MudCard>
            </MudItem>
            
            <!-- Results -->
            @if (analysisResult != null)
            {
                <MudItem xs="12">
                    <MudCard Elevation="3" Class="pa-4">
                        <MudText Typo="Typo.h6" Class="mb-3">Información Extraída</MudText>
                        
                        @if (analysisResult.Success)
                        {
                            <MudGrid>
                                <MudItem xs="12" sm="6" md="4">
                                    <MudTextField Value="@analysisResult.ExtractedData.ClientName"
                                                  Label="Cliente"
                                                  Variant="Variant.Outlined"
                                                  ReadOnly="true" />
                                </MudItem>
                                <MudItem xs="12" sm="6" md="4">
                                    <MudTextField Value="@analysisResult.ExtractedData.ProjectName"
                                                  Label="Proyecto"
                                                  Variant="Variant.Outlined"
                                                  ReadOnly="true" />
                                </MudItem>
                                <MudItem xs="12" sm="6" md="4">
                                    <MudTextField Value="@analysisResult.ExtractedData.UseCaseName"
                                                  Label="Caso de Uso"
                                                  Variant="Variant.Outlined"
                                                  ReadOnly="true" />
                                </MudItem>
                                <MudItem xs="12">
                                    <MudTextField Value="@analysisResult.ExtractedData.Description"
                                                  Label="Descripción"
                                                  Variant="Variant.Outlined"
                                                  Lines="3"
                                                  ReadOnly="true" />
                                </MudItem>
                            </MudGrid>
                            
                            <MudDivider Class="my-4" />
                            
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Success"
                                       StartIcon="@Icons.Material.Filled.Create"
                                       OnClick="CreateUseCaseFromAnalysis">
                                Crear Caso de Uso con Esta Información
                            </MudButton>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Error">
                                Error en el análisis: @analysisResult.Error
                            </MudAlert>
                        }
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    </MudPaper>
</MudContainer>

<style>
    .thinking-button {
        position: relative;
        overflow: hidden;
        background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%) !important;
        border: none !important;
        animation: thinking-pulse 2s ease-in-out infinite;
    }

    .thinking-button-content {
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        gap: 8px;
    }

    .thinking-pulse {
        position: absolute;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        animation: pulse-expand 1.5s ease-in-out infinite;
        left: 16px;
    }

    .thinking-text {
        color: white;
        font-weight: 500;
        display: flex;
        align-items: baseline;
        margin-left: 24px;
    }

    .thinking-dots {
        margin-left: 2px;
        animation: thinking-dots-fade 1.5s ease-in-out infinite;
    }

    @@keyframes thinking-pulse {
        0% { box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(147, 51, 234, 0); }
        100% { box-shadow: 0 0 0 0 rgba(147, 51, 234, 0); }
    }

    @@keyframes pulse-expand {
        0% { transform: scale(0.8); opacity: 0.8; }
        50% { transform: scale(1.2); opacity: 0.3; }
        100% { transform: scale(0.8); opacity: 0.8; }
    }

    @@keyframes thinking-dots-fade {
        0% { opacity: 0.4; }
        50% { opacity: 1; }
        100% { opacity: 0.4; }
    }
</style>

@code {
    private AIModel selectedAIModel = AIModel.Demo;
    private string minuteContent = "";
    private IBrowserFile? uploadedFile;
    private bool isAnalyzing = false;
    private MinuteAnalysisResponse? analysisResult;
    private string dragClass = "";
    private readonly string defaultDragClass = "relative rounded-lg border-2 border-dashed pa-4 mt-4 mud-width-full mud-height-full z-10";
    
    // Thinking animation variables
    private string currentDots = "...";
    private System.Timers.Timer? dotsTimer;
    private int dotsState = 0;

    private async Task OnInputFileChanged(InputFileChangeEventArgs e)
    {
        uploadedFile = e.File;
        ClearDragClass();
        
        if (uploadedFile != null)
        {
            // Read file content
            using var reader = new StreamReader(uploadedFile.OpenReadStream());
            minuteContent = await reader.ReadToEndAsync();
        }
    }

    private void SetDragClass() => dragClass = $"{defaultDragClass} mud-border-primary";
    
    private void ClearDragClass() => dragClass = defaultDragClass;

    private async Task AnalyzeMinute()
    {
        if (string.IsNullOrWhiteSpace(minuteContent))
        {
            Snackbar.Add("Debes proporcionar contenido para analizar", Severity.Warning);
            return;
        }

        isAnalyzing = true;
        StartDotsAnimation();
        try
        {
            var request = new MinuteAnalysisRequest
            {
                Content = minuteContent,
                AiModel = selectedAIModel
            };

            analysisResult = await AIAssistService.AnalyzeMinuteAsync(request);
            
            if (analysisResult.Success)
            {
                Snackbar.Add("Análisis completado exitosamente", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Error en el análisis: {analysisResult.Error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            StopDotsAnimation();
            isAnalyzing = false;
        }
    }

    private void StartDotsAnimation()
    {
        dotsTimer = new System.Timers.Timer(400); // Change every 400ms
        dotsTimer.Elapsed += UpdateDots;
        dotsTimer.AutoReset = true;
        dotsTimer.Start();
    }

    private void StopDotsAnimation()
    {
        dotsTimer?.Stop();
        dotsTimer?.Dispose();
        dotsTimer = null;
        currentDots = "...";
        dotsState = 0;
    }

    private async void UpdateDots(object? sender, System.Timers.ElapsedEventArgs e)
    {
        await InvokeAsync(() =>
        {
            dotsState = (dotsState + 1) % 4;
            currentDots = dotsState switch
            {
                0 => "...",
                1 => "....",
                2 => ".....",
                3 => "......",
                _ => "..."
            };
            StateHasChanged();
        });
    }

    private void CreateUseCaseFromAnalysis()
    {
        if (analysisResult?.Success == true)
        {
            // TODO: Navigate to generator with pre-filled data
            Navigation.NavigateTo("/generator");
            Snackbar.Add("Navegando al generador con datos pre-cargados", Severity.Info);
        }
    }
}